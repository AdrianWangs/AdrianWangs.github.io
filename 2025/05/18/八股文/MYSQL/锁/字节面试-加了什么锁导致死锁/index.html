<!DOCTYPE html>
<html lang="zh">
<head><!-- hexo injector head_begin start --><script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"adrianwangs.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="深入分析MySQL中常见的锁机制，探讨不同锁类型如何导致死锁，并结合字节跳动面试题场景进行解析。">
<meta property="og:type" content="article">
<meta property="og:title" content="字节面试：加了什么锁，导致死锁？">
<meta property="og:url" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/index.html">
<meta property="og:site_name" content="Adrian Wang&#39;s blog">
<meta property="og:description" content="深入分析MySQL中常见的锁机制，探讨不同锁类型如何导致死锁，并结合字节跳动面试题场景进行解析。">
<meta property="og:locale">
<meta property="og:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568234814.png">
<meta property="og:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568246886.png">
<meta property="og:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1748172465154.png">
<meta property="og:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568314475.png">
<meta property="og:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568326650.png">
<meta property="og:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568340862.png">
<meta property="og:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568351456.png">
<meta property="article:published_time" content="2025-05-18T12:00:00.000Z">
<meta property="article:modified_time" content="2025-08-03T08:26:58.701Z">
<meta property="article:author" content="Adrian Wang">
<meta property="article:tag" content="面试题">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="死锁">
<meta property="article:tag" content="锁">
<meta property="article:tag" content="字节跳动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568234814.png">

<link rel="canonical" href="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh'
  };
</script>

  <title>字节面试：加了什么锁，导致死锁？ | Adrian Wang's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Adrian Wang's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个完全由AI生成，但是内容高质量的Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-全部文章">

    <a href="/archives" rel="section"><i class="fa fa-th-list fa-fw"></i>全部文章</a>

  </li>
        <li class="menu-item menu-item-面试经验">

    <a href="/interview" rel="section"><i class="fa fa-briefcase fa-fw"></i>面试经验</a>

  </li>
        <li class="menu-item menu-item-golang">

    <a href="/golang" rel="section"><i class="fa fa-brands fa-golang fa-fw"></i>Golang</a>

  </li>
        <li class="menu-item menu-item-mysql">

    <a href="/mysql" rel="section"><i class="fa fa-database fa-fw"></i>MySQL</a>

  </li>
        <li class="menu-item menu-item-redis">

    <a href="/redis" rel="section"><i class="fa fa-fire fa-fw"></i>Redis</a>

  </li>
        <li class="menu-item menu-item-计算机网络">

    <a href="/network" rel="section"><i class="fa fa-globe fa-fw"></i>计算机网络</a>

  </li>
        <li class="menu-item menu-item-leetcode题解">

    <a href="/algorithms" rel="section"><i class="fa fa-book fa-fw"></i>Leetcode题解</a>

  </li>
        <li class="menu-item menu-item-关于我">

    <a href="/about" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/AdrianWangs" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://adrianwangs.github.io/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/72337244">
      <meta itemprop="name" content="Adrian Wang">
      <meta itemprop="description" content="一个完全由AI生成，但是内容高质量的Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Adrian Wang's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          字节面试：加了什么锁，导致死锁？
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-05-18 12:00:00" itemprop="dateCreated datePublished" datetime="2025-05-18T12:00:00+00:00">2025-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-03 08:26:58" itemprop="dateModified" datetime="2025-08-03T08:26:58+00:00">2025-08-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%AB%E8%82%A1%E6%96%87/" itemprop="url" rel="index"><span itemprop="name">八股文</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%AB%E8%82%A1%E6%96%87/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%AB%E8%82%A1%E6%96%87/MySQL/%E9%94%81/" itemprop="url" rel="index"><span itemprop="name">锁</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>
            <div class="post-description">深入分析MySQL中常见的锁机制，探讨不同锁类型如何导致死锁，并结合字节跳动面试题场景进行解析。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1>字节面试：加了什么锁，导致死锁的？</h1>
<p>这是一个来自字节跳动面试的经典 MySQL 问题。面试官可能会这样提问：“在<strong>可重复读（Repeatable Read）隔离级别</strong>下，以下场景会发生什么情况？”</p>
<p>面试题中涉及一个名为 <code>students</code> 的表，其结构包含 <code>id</code> (主键), <code>no</code>, <code>name</code>, <code>age</code>, <code>score</code> 字段。为了便于实验和分析，我们接下来将使用一个结构相同但表名为 <code>t_student</code> 的表。<br>
<code>students</code> (即我们实验中的 <code>t_student</code>) 表的初始数据大致如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>no</th>
<th>name</th>
<th>age</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>15</td>
<td>S0001</td>
<td>Bob</td>
<td>25</td>
<td>34</td>
</tr>
<tr>
<td>18</td>
<td>S0002</td>
<td>Alice</td>
<td>24</td>
<td>77</td>
</tr>
<tr>
<td>20</td>
<td>S0003</td>
<td>Jim</td>
<td>24</td>
<td>5</td>
</tr>
<tr>
<td>30</td>
<td>S0004</td>
<td>Eric</td>
<td>23</td>
<td>91</td>
</tr>
<tr>
<td>37</td>
<td>S0005</td>
<td>Tom</td>
<td>22</td>
<td>22</td>
</tr>
<tr>
<td>49</td>
<td>S0006</td>
<td>Tom</td>
<td>25</td>
<td>83</td>
</tr>
<tr>
<td>50</td>
<td>S0007</td>
<td>Rose</td>
<td>23</td>
<td>89</td>
</tr>
</tbody>
</table>
<p>在此场景中，有两个并发事务正在执行：</p>
<ul>
<li><strong>事务 A</strong> 按顺序执行以下操作：
<ol>
<li><code>time1</code>: <code>UPDATE students SET score=100 WHERE id=25;</code></li>
<li><code>time3</code>: <code>INSERT INTO students(id, no, name, age, score) VALUES (25, 's0025', 'sony', 28, 90);</code></li>
</ol>
</li>
<li><strong>事务 B</strong> 按顺序执行以下操作：
<ol>
<li><code>time2</code>: <code>UPDATE students SET score=100 WHERE id=26;</code></li>
<li><code>time4</code>: <code>INSERT INTO students(id, no, name, age, score) VALUES (26, 's0026', 'ace', 28, 90);</code></li>
</ol>
</li>
</ul>
<p>如果对 MySQL 加锁机制比较熟悉，可能一眼就能看出这个场景下<strong>会发生死锁</strong>。但更进一步的问题是：具体是加了什么锁？这些锁之间是如何相互作用最终导致死锁的？</p>
<p>接下来，本文将详细分析上述两个事务在执行 SQL 语句的过程中，分别获取了哪些锁，以及这些锁是如何一步步导致死锁的。</p>
<h2 id="准备工作">准备工作</h2>
<p>先创建一张 t_student 表，假设除了 id 字段，其他字段都是普通字段。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> `t_student` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `<span class="keyword">no</span>` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `score` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>
<p>然后，插入相关的数据后，t_student 表中的记录如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>no</th>
<th>name</th>
<th>age</th>
<th>score</th>
</tr>
</thead>
<tbody>
<tr>
<td>15</td>
<td>S0001</td>
<td>Bob</td>
<td>25</td>
<td>34</td>
</tr>
<tr>
<td>18</td>
<td>S0002</td>
<td>Alice</td>
<td>24</td>
<td>77</td>
</tr>
<tr>
<td>20</td>
<td>S0003</td>
<td>Jim</td>
<td>24</td>
<td>5</td>
</tr>
<tr>
<td>30</td>
<td>S0004</td>
<td>Eric</td>
<td>23</td>
<td>91</td>
</tr>
<tr>
<td>37</td>
<td>S0005</td>
<td>Tom</td>
<td>22</td>
<td>22</td>
</tr>
<tr>
<td>49</td>
<td>S0006</td>
<td>Tom</td>
<td>25</td>
<td>83</td>
</tr>
<tr>
<td>50</td>
<td>S0007</td>
<td>Rose</td>
<td>23</td>
<td>89</td>
</tr>
</tbody>
</table>
<h2 id="开始实验">开始实验</h2>
<p>在实验开始前，先说明下实验环境：</p>
<ul>
<li>MySQL 版本：8.0.26</li>
<li>隔离级别：可重复读（RR）</li>
</ul>
<p>启动两个事务，按照题目的 SQL 执行顺序，过程如下表格：</p>
<p><img src="/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568234814.png" alt="1747568234814"></p>
<p>可以看到，事务 A 和 事务 B 都在执行 insert 语句后，都陷入了等待状态（前提没有打开死锁检测），也就是发生了死锁，因为都在相互等待对方释放锁。（注意：在 MySQL 默认配置下，死锁检测是开启的。如果开启，其中一个事务（通常是持有锁较少或回滚代价较小的那个）会被选中作为牺牲者并回滚，同时向客户端返回死锁错误，例如 <code>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</code>。本文描述两个事务都陷入等待是为了清晰展示死锁形成的完整过程。）</p>
<h2 id="为什么会发生死锁？">为什么会发生死锁？</h2>
<p>我们可以通过 <code>select * from performance_schema.data_locks\G;</code> 这条语句，查看事务执行 SQL 过程中加了什么锁。</p>
<p>接下来，针对每一条 SQL 语句分析具体加了什么锁。</p>
<h3 id="Time-1-阶段加锁分析">Time 1 阶段加锁分析</h3>
<p>Time 1 阶段，事务 A 执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 事务 A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> t_student <span class="keyword">set</span> score <span class="operator">=</span> <span class="number">100</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">0</span>  Changed: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>然后执行 <code>select * from performance_schema.data_locks\G;</code> 这条语句，查看事务 A 此时加了什么锁。</p>
<p><img src="/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568246886.png" alt="1747568246886"></p>
<p>从上图可以看到，共加了两个锁，分别是：</p>
<ul>
<li>表级锁：一个 X 类型的意向锁 (IX lock)。这是因为事务需要在表中的行上加 X 锁（无论是记录锁还是间隙锁），所以先在表上加 IX 锁。</li>
<li>行级锁：一个 X 类型的间隙锁 (Gap Lock)；</li>
</ul>
<p>这里我们重点关注行锁，图中 LOCK_TYPE 中的 RECORD 表示行级锁，而不是记录锁的意思，通过 LOCK_MODE 可以确认是 next-key 锁，还是间隙锁，还是记录锁：</p>
<ul>
<li>如果 LOCK_MODE 为 <code>X</code>，说明是 next-key 锁；</li>
<li>如果 LOCK_MODE 为 <code>X, REC_NOT_GAP</code>，说明是记录锁；</li>
<li>如果 LOCK_MODE 为 <code>X, GAP</code>，说明是间隙锁；</li>
</ul>
<p><strong>因此，此时事务 A 在主键索引（INDEX_NAME : PRIMARY）上加的是 X 型间隙锁，锁范围是<code>(20, 30)</code></strong>。</p>
<blockquote>
<p>间隙锁的范围<code>(20, 30)</code> ，是怎么确定的？</p>
</blockquote>
<p>当 <code>UPDATE</code> 语句的 <code>WHERE</code> 条件（如 <code>id = 25</code>）没有命中任何现有记录时，在可重复读隔离级别下，InnoDB 会为了防止幻读而加上间隙锁。<br>
该间隙锁的范围确定方式如下：</p>
<ul>
<li><code>LOCK_DATA</code> (在此例中为 <code>30</code>) 通常表示该间隙锁范围的右边界（不包含）。这是因为 <code>id=30</code> 是主键索引中大于 <code>25</code> 的第一条记录。</li>
<li>间隙锁范围的左边界（不包含）则是主键索引中小于 <code>25</code> 的最大一条记录的 <code>id</code> 值，即 <code>20</code>。<br>
所以，形成的间隙为 <code>(20, 30)</code>。这个锁确保了在 <code>id</code> 值为 20 和 30 之间的这个区间，没有新的记录可以被插入，从而保证了事务 A 的可重复读。</li>
</ul>
<p><img src="/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1748172465154.png" alt="1748172465154"></p>
<p>因此，间隙锁的范围是 <code>(20, 30)</code>。</p>
<h3 id="Time-2-阶段加锁分析">Time 2 阶段加锁分析</h3>
<p>Time 2 阶段，事务 B 执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 事务 B</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> t_student <span class="keyword">set</span> score <span class="operator">=</span> <span class="number">100</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">26</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">0</span>  Changed: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>然后执行 <code>select * from performance_schema.data_locks\G;</code> 这条语句，查看事务 B 此时加了什么锁。</p>
<p><img src="/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568314475.png" alt="1747568314475"></p>
<p>从上图可以看到，行锁是 X 类型的间隙锁，间隙锁的范围是<code>(20, 30)</code>。</p>
<blockquote>
<p>事务 A 和 事务 B 的间隙锁范围都是一样的，为什么不会冲突？</p>
</blockquote>
<p>两个事务的间隙锁之间是相互兼容的，不会产生冲突。</p>
<p>在 MySQL 官网上还有一段非常关键的描述：</p>
<p><em>Gap locks in InnoDB are “purely inhibitive”, which means that their only purpose is to prevent other transactions from Inserting to the gap. Gap locks can co-exist. A gap lock taken by one transaction does not prevent another transaction from taking a gap lock on the same gap. There is no difference between shared and exclusive gap locks. They do not conflict with each other, and they perform the same function.</em></p>
<p><strong>间隙锁的意义只在于阻止区间被插入</strong>，因此是可以共存的。<strong>一个事务获取的间隙锁不会阻止另一个事务获取同一个间隙范围的间隙锁</strong>，共享（S 型）和排他（X 型）的间隙锁是没有区别的，他们相互不冲突，且功能相同。</p>
<h3 id="Time-3-阶段加锁分析">Time 3 阶段加锁分析</h3>
<p>Time 3，事务 A 插入了一条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># <span class="type">Time</span> <span class="number">3</span> 阶段，事务 A 插入了一条记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t_student(id, <span class="keyword">no</span>, name, age,score) <span class="keyword">value</span> (<span class="number">25</span>, <span class="string">&#x27;S0025&#x27;</span>, <span class="string">&#x27;sony&#x27;</span>, <span class="number">28</span>, <span class="number">90</span>);</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="operator">/</span> 阻塞等待......</span><br></pre></td></tr></table></figure>
<p>此时，事务 A 就陷入了等待状态。</p>
<p>然后执行 <code>select * from performance_schema.data_locks\G;</code> 这条语句，查看事务 A 在获取什么锁而导致被阻塞。</p>
<p><img src="/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568326650.png" alt="1747568326650"></p>
<p>可以看到，事务 A 的状态为等待状态（LOCK_STATUS: WAITING）。这是因为它试图在 <code>id=25</code> 的位置插入记录，该位置位于事务 B 持有的间隙锁 <code>(20, 30)</code> 范围内。为了执行插入，事务 A 需要获取一个插入意向锁。然而，<strong>插入意向锁与另一个事务持有的间隙锁是冲突的</strong>。因此，事务 A 的插入操作被阻塞，等待事务 B 释放其在 <code>(20, 30)</code> 上的间隙锁。此时，事务 A 自身也持有 <code>(20,30)</code> 的间隙锁。</p>
<blockquote>
<p>插入意向锁是什么？</p>
</blockquote>
<p>注意！插入意向锁名字里虽然有意向锁这三个字，但是它并不是意向锁，它属于行级锁，是一种特殊的间隙锁。</p>
<p>在 MySQL 的官方文档中有以下重要描述：</p>
<p><em>An Insert intention lock is a type of gap lock set by Insert operations prior to row Insertion. This lock signals the intent to Insert in such a way that multiple transactions Inserting into the same index gap need not wait for each other if they are not Inserting at the same position within the gap. Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to Insert values of 5 and 6, respectively, each lock the gap between 4 and 7 with Insert intention locks prior to obtaining the exclusive lock on the Inserted row, but do not block each other because the rows are nonconflicting.</em></p>
<p>这段话表明尽管<strong>插入意向锁是一种特殊的间隙锁，但不同于间隙锁的是，该锁只用于并发插入操作</strong>。</p>
<p>如果说间隙锁锁住的是一个区间，那么「插入意向锁」锁住的就是一个点。因而从这个角度来说，插入意向锁确实是一种特殊的间隙锁。</p>
<p>插入意向锁与间隙锁的另一个非常重要的差别是：<strong>尽管「插入意向锁」也属于间隙锁，但两个事务却不能在同一时间内，一个拥有间隙锁，另一个拥有该间隙区间内的插入意向锁（当然，插入意向锁如果不在间隙锁区间内则是可以的）。所以，插入意向锁和间隙锁之间是冲突的</strong>。</p>
<p>另外，我补充一点，插入意向锁的生成时机：</p>
<ul>
<li>每插入一条新记录，都需要看一下待插入记录的下一条记录上是否已经被加了间隙锁，如果已加间隙锁，此时会生成一个插入意向锁，然后锁的状态设置为等待状态（<em>PS：MySQL 加锁时，是先生成锁结构，然后设置锁的状态，如果锁状态是等待状态，并不是意味着事务成功获取到了锁，只有当锁状态为正常状态时，才代表事务成功获取到了锁</em>），现象就是 Insert 语句会被阻塞。</li>
</ul>
<h3 id="Time-4-阶段加锁分析">Time 4 阶段加锁分析</h3>
<p>Time 4，事务 B 插入了一条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># <span class="type">Time</span> <span class="number">4</span> 阶段，事务 B 插入了一条记录</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert into</span> t_student(id, <span class="keyword">no</span>, name, age,score) <span class="keyword">value</span> (<span class="number">26</span>, <span class="string">&#x27;S0026&#x27;</span>, <span class="string">&#x27;ace&#x27;</span>, <span class="number">28</span>, <span class="number">90</span>);</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="operator">/</span> 阻塞等待......</span><br></pre></td></tr></table></figure>
<p>此时，事务 B 就陷入了等待状态。</p>
<p>然后执行 <code>select * from performance_schema.data_locks\G;</code> 这条语句，查看事务 B 在获取什么锁而导致被阻塞。</p>
<p><img src="/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568340862.png" alt="1747568340862"></p>
<p>可以看到，事务 B 也因尝试获取插入意向锁而被阻塞（LOCK_STATUS: WAITING）。事务 B 试图在 <code>id=26</code> 的位置插入记录，该位置同样位于事务 A 持有的间隙锁 <code>(20, 30)</code> 范围内。与事务 A 的情况类似，事务 B 的插入操作需要获取插入意向锁，而这个锁与事务 A 持有的间隙锁 <code>(20, 30)</code> 冲突。因此，事务 B 等待事务 A 释放其间隙锁。</p>
<blockquote>
<p>最后回答，为什么会发生死锁？</p>
</blockquote>
<p>死锁的发生是因为两个事务形成了循环等待资源。具体分析如下：</p>
<ol>
<li>
<p><strong>初始状态</strong>：</p>
<ul>
<li>事务 A 执行 <code>UPDATE ... WHERE id = 25</code>，未找到记录，获得了间隙锁 G_A 对 <code>(20, 30)</code>。</li>
<li>事务 B 执行 <code>UPDATE ... WHERE id = 26</code>，未找到记录，获得了间隙锁 G_B 对 <code>(20, 30)</code>。</li>
<li>间隙锁之间是兼容的，所以事务 A 和 B 此时都成功持有各自的间隙锁。</li>
</ul>
</li>
<li>
<p><strong>事务 A 尝试插入</strong>：</p>
<ul>
<li>事务 A 执行 <code>INSERT INTO t_student VALUES (25, ...)</code>。</li>
<li>为了插入 <code>id=25</code>，事务 A 需要获取一个插入意向锁 (II_A) 作用于 <code>id=25</code> 所在的位置。</li>
<li>这个位置 <code>id=25</code> 位于事务 B 持有的间隙锁 G_B <code>(20, 30)</code> 范围内。</li>
<li>插入意向锁 II_A 与其他事务持有的间隙锁 G_B 冲突。</li>
<li>因此，事务 A 等待事务 B 释放间隙锁 G_B。</li>
</ul>
</li>
<li>
<p><strong>事务 B 尝试插入</strong>：</p>
<ul>
<li>事务 B 执行 <code>INSERT INTO t_student VALUES (26, ...)</code>。</li>
<li>为了插入 <code>id=26</code>，事务 B 需要获取一个插入意向锁 (II_B) 作用于 <code>id=26</code> 所在的位置。</li>
<li>这个位置 <code>id=26</code> 位于事务 A 持有的间隙锁 G_A <code>(20, 30)</code> 范围内。</li>
<li>插入意向锁 II_B 与其他事务持有的间隙锁 G_A 冲突。</li>
<li>因此，事务 B 等待事务 A 释放间隙锁 G_A。</li>
</ul>
</li>
<li>
<p><strong>循环等待</strong>：</p>
<ul>
<li>事务 A 持有 G_A，等待 G_B。</li>
<li>事务 B 持有 G_B，等待 G_A。</li>
<li>这就构成了循环等待，满足了死锁的条件（互斥、占有并等待、不可抢占、循环等待），因此发生死锁。</li>
</ul>
</li>
</ol>
<p>简而言之，两个事务都先获取了相同范围的间隙锁（这是允许的），然后又都试图在这个被对方锁定的间隙内插入数据，从而需要获取插入意向锁。由于插入意向锁与对方的间隙锁冲突，导致了相互等待。</p>
<h2 id="总结">总结</h2>
<p>两个事务即使生成的间隙锁的范围是一样的，也不会发生冲突，因为间隙锁目的是为了防止其他事务插入数据，因此间隙锁与间隙锁之间是相互兼容的。</p>
<p>在执行插入语句时，如果插入的记录在其他事务持有间隙锁范围内，插入语句就会被阻塞，因为插入语句在碰到间隙锁时，会生成一个插入意向锁，然后插入意向锁和间隙锁之间是互斥的关系。</p>
<p>如果两个事务分别向对方持有的间隙锁范围内插入一条记录，而插入操作为了获取到插入意向锁，都在等待对方事务的间隙锁释放，于是就造成了循环等待，满足了死锁的四个条件：<strong>互斥、占有且等待、不可强占用、循环等待</strong>，因此发生了死锁。</p>
<h2 id="读者问答">读者问答</h2>
<p><img src="/2025/05/18/%E5%85%AB%E8%82%A1%E6%96%87/MYSQL/%E9%94%81/%E5%AD%97%E8%8A%82%E9%9D%A2%E8%AF%95-%E5%8A%A0%E4%BA%86%E4%BB%80%E4%B9%88%E9%94%81%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81/1747568351456.png" alt="1747568351456"></p>

      
    </div>

    

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag"># 面试题</a>
              <a href="/tags/MySQL/" rel="tag"># MySQL</a>
              <a href="/tags/%E6%AD%BB%E9%94%81/" rel="tag"># 死锁</a>
              <a href="/tags/%E9%94%81/" rel="tag"># 锁</a>
              <a href="/tags/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8/" rel="tag"># 字节跳动</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/05/17/%E7%AE%97%E6%B3%95%E5%88%B7%E9%A2%98/LeetCode-416-%E5%88%86%E5%89%B2%E7%AD%89%E5%92%8C%E5%AD%90%E9%9B%86/" rel="prev" title="LeetCode 416 - 分割等和子集 (Partition Equal Subset Sum)">
      <i class="fa fa-chevron-left"></i> LeetCode 416 - 分割等和子集 (Partition Equal Subset Sum)
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/05/18/%E7%AE%97%E6%B3%95%E5%88%B7%E9%A2%98/leetcode-32-longest-valid-parentheses-dp-error-analysis/" rel="next" title="❌ LeetCode 32 - 最长有效括号：动态规划思路错题分析">
      ❌ LeetCode 32 - 最长有效括号：动态规划思路错题分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">字节面试：加了什么锁，导致死锁的？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E5%AE%9E%E9%AA%8C"><span class="nav-number">1.2.</span> <span class="nav-text">开始实验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%8F%91%E7%94%9F%E6%AD%BB%E9%94%81%EF%BC%9F"><span class="nav-number">1.3.</span> <span class="nav-text">为什么会发生死锁？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Time-1-%E9%98%B6%E6%AE%B5%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"><span class="nav-number">1.3.1.</span> <span class="nav-text">Time 1 阶段加锁分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Time-2-%E9%98%B6%E6%AE%B5%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"><span class="nav-number">1.3.2.</span> <span class="nav-text">Time 2 阶段加锁分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Time-3-%E9%98%B6%E6%AE%B5%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"><span class="nav-number">1.3.3.</span> <span class="nav-text">Time 3 阶段加锁分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Time-4-%E9%98%B6%E6%AE%B5%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"><span class="nav-number">1.3.4.</span> <span class="nav-text">Time 4 阶段加锁分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E8%80%85%E9%97%AE%E7%AD%94"><span class="nav-number">1.5.</span> <span class="nav-text">读者问答</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Adrian Wang"
      src="https://avatars.githubusercontent.com/u/72337244">
  <p class="site-author-name" itemprop="name">Adrian Wang</p>
  <div class="site-description" itemprop="description">一个完全由AI生成，但是内容高质量的Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">171</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">231</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/AdrianWangs" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AdrianWangs" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wyz17601402786@gmail.com" title="E-Mail → mailto:wyz17601402786@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Adrian Wang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">760k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">11:31</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
const mermaidBlocks = document.querySelectorAll('pre.mermaid'); // Get all mermaid blocks
if (mermaidBlocks.length) {
  console.log('Found Mermaid blocks:', mermaidBlocks.length); // Log how many blocks were found

  // Log the content of each block before initialization
  mermaidBlocks.forEach((block, index) => {
    console.log(`--- Mermaid Block ${index + 1} Content ---`);
    console.log(block.textContent || block.innerText); // Log the raw text content
    console.log(`--------------------------------------`);
  });

  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.js', () => {
    console.log('Mermaid script loaded. Initializing...'); // Log initialization start
    try { // Add try...catch around initialization and rendering
      mermaid.initialize({
        theme    : 'forest',
        logLevel : 3, // Keep logLevel 3 for potential Mermaid internal logs
        flowchart: { curve     : 'linear' },
        gantt    : { axisFormat: '%m/%d/%Y' },
        sequence : { actorMargin: 50 }
        // Consider adding startOnLoad: false if you manually call mermaid.run() later
        // startOnLoad: false
      });
      console.log('Mermaid initialized.');

      // Explicitly render after initialization (if startOnLoad is false or for clarity)
      // mermaid.run({ nodes: mermaidBlocks }); // Or mermaid.init(undefined, mermaidBlocks); depending on version
      // console.log('Mermaid rendering attempted.');

    } catch (e) {
      console.error('Error during Mermaid initialization or rendering:', e);
    }
  }, window.mermaid);
} else {
  console.log('No Mermaid blocks found on this page.');
}
</script>

  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'Ov23ctYPrSZhEEiMSWnG',
      clientSecret: '868a26bca9ec039212bdc83e05c4420b6077e9f4',
      repo        : 'blog-comments',
      owner       : 'AdrianWangs',
      admin       : ['AdrianWangs'],
      id          : '9eb101d9c89ed66abc30e15937a97530',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const heatmapChartDom = document.getElementById('heatmapChart');
                if(heatmapChartDom){
                    const heatmapChart = echarts.init(heatmapChartDom, 'dark');
                    const cellSize = [18, 18];
                    
                    const groupByYear = (data) => {
                        const result = {};
                        data.forEach(([date, value]) => {
                            const [year] = date.split('-').map(Number);
                            if (!result[year]) {
                                result[year] = [];
                            }
                            result[year].push([date, value]);
                        });
                        return result;
                    };
                    
                    const groupedData = groupByYear([["2024-07-30",1],["2025-04-18",2],["2025-04-19",2],["2025-04-20",3],["2025-04-21",2],["2025-04-22",3],["2025-04-23",2],["2025-04-24",4],["2025-04-25",2],["2025-04-27",1],["2025-04-28",2],["2025-04-29",5],["2025-04-30",3],["2025-05-02",1],["2025-05-03",1],["2025-05-04",3],["2025-05-05",4],["2025-05-06",5],["2025-05-07",3],["2025-05-08",4],["2025-05-10",8],["2025-05-11",4],["2025-05-12",1],["2025-05-13",3],["2025-05-14",2],["2025-05-15",1],["2025-05-16",5],["2025-05-17",4],["2025-05-18",4],["2025-05-20",2],["2025-05-21",6],["2025-05-22",2],["2025-05-24",2],["2025-05-25",4],["2025-05-26",2],["2025-05-27",4],["2025-05-28",1],["2025-05-30",4],["2025-05-31",1],["2025-06-01",1],["2025-06-02",1],["2025-06-03",3],["2025-06-04",1],["2025-06-05",1],["2025-06-06",2],["2025-06-07",1],["2025-06-08",6],["2025-06-09",1],["2025-06-13",1],["2025-06-15",3],["2025-06-16",9],["2025-06-17",3],["2025-06-18",1],["2025-06-21",5],["2025-06-22",4],["2025-06-23",1],["2025-06-25",1],["2025-06-29",2],["2025-07-01",1],["2025-07-02",1],["2025-07-03",1],["2025-07-06",1],["2025-07-09",1],["2025-07-20",3],["2025-07-26",2],["2025-08-03",1]]);
                    const years = Object.keys(groupedData).reverse();
                    
                    var initYear = parseInt(heatmapChartDom.getAttribute('year')) || new Date().getFullYear();
                    const minYear = years[years.length - 1];
                    const maxYear = years[0];
                    if (initYear < minYear || initYear > maxYear) {
                        initYear = maxYear;
                    }
                    console.log('[hexo-graph]generateHeatmapChart|initYear:', initYear, 'minYear:', minYear, 'maxYear:', maxYear);
                    
                    heatmapChart.setOption({
                        grid: {},
                        tooltip: { 
                            position: 'top', 
                            formatter: params => `${params.value[0]}: ${params.value[1]} Articles` 
                        },
                        calendar: { 
                            top: '10%',
                            left: 'left', 
                            right: '8%',
                            range: initYear,
                            cellSize: cellSize, 
                            splitLine: { lineStyle: { color: '#E0E0E0', width: 1 } }, 
                            itemStyle: { borderWidth: 1, borderColor: '#E0E0E0' }, 
                            dayLabel: { show: false },
                            monthLabel: { show: true },
                            yearLabel: { show: false },
                        },
                        visualMap: { 
                            show: true,
                            right: '8%',
                            bottom: '5%',
                            type: 'piecewise',
                            orient: 'horizontal',
                            text: ['More', 'Less'],
                            min: 0,
                            max: Math.max(...groupedData[initYear].map(item => item[1])),
                            inRange: { color: ["#ACE7AE","#69C16D","#549F57"] }
                        },
                        legend: {
                            type: 'scroll',
                            icon: 'none',
                            data: years,
                            orient: 'vertical',
                            top: '5%',
                            right: 'right',
                            itemWidth: 20,
                            itemHeight: 20,
                            itemGap: 10,
                            pageIconSize: 10,
                            pageTextStyle: { fontSize: 14 },
                            selectedMode: 'single',
                        },
                        series: years.map(year => ({
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            data: groupedData[year],
                            name: year,
                            emphasis: {
                                disabled: true,
                            },
                            silent: year !== initYear,
                        })),
                    });
                    
                    // init selected year
                    heatmapChart.dispatchAction({
                        type: 'legendSelect',
                        name: initYear,
                    });
                    
                    heatmapChart.on('legendselectchanged', function(params) {
                        console.log('[hexo-graph]generateHeatmapChart|legendselectchanged:', params);
                        const selectedYear = Object.keys(params.selected).find(key => params.selected[key]);
                        if (selectedYear && groupedData[selectedYear]) {
                            heatmapChart.setOption({
                                calendar: {
                                    range: selectedYear,
                                },
                                visualMap: {
                                    max: Math.max(...groupedData[selectedYear].map(item => item[1])),
                                },
                                series: years.map(year => ({
                                    type: 'heatmap',
                                    coordinateSystem: 'calendar',
                                    data: groupedData[year],
                                    name: year,
                                    emphasis: {
                                        disabled: true,
                                    },
                                    silent: year !== selectedYear,
                                })),
                            });
                        }
                    });
                    
                    heatmapChart.on('click', function (params) {
                        if (params.componentType === 'series') {
                            const [year, month] = params.value[0].split('-');
                            window.location.href = '/archives/' + year + '/' + month;
                        }
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const monthlyChartDom = document.getElementById('monthlyChart');
                if(monthlyChartDom){
                    const monthlyChart = echarts.init(monthlyChartDom, 'dark');
                    monthlyChart.setOption({
                        xAxis: { 
                            type: 'category', 
                            data: ["2024-07","2025-04","2025-05","2025-06","2025-07","2025-08"], 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        series: [{
                            name: 'Articles',
                            type: 'line',
                            data: [1,31,81,47,10,1],
                            smooth: true,
                            lineStyle: { color: '#5470C6', width: 2 },
                            itemStyle: { color: '#5470C6' },
                            areaStyle: { color: 'rgba(84, 112, 198, 0.4)' },
                            symbolSize: 10,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            }
                        }]
                    });

                    monthlyChart.on('click', function (params) {
                        const [year, month] = params.name.split('-');
                        window.location.href = '/archives/' + year + '/' + month;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const tagsChartDom = document.getElementById('tagsChart');
                if(tagsChartDom){
                    const tagsChart = echarts.init(tagsChartDom, 'dark');
                    tagsChart.setOption({
                        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                        series: [{
                            type: 'pie',
                            radius: '60%',
                            data: [{"name":"LeetCode","value":88},{"name":"Medium","value":70},{"name":"Hot100","value":58},{"name":"数组","value":34},{"name":"面试经典150","value":32},{"name":"八股文","value":25},{"name":"❌错题集","value":25},{"name":"深度优先搜索","value":22}],
                            label: {
                                position: 'outside',
                                formatter: '{b} {c} ({d}%)',
                                fontSize: 14,
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            color: ["#5470C6","#91CC75","#FAC858","#EE6666","#73C0DE","#3BA272","#FC8452","#9A60B4"],
                            labelLine: { show: true }
                        }],
                        legend: {
                            bottom: '0',
                            left: 'center',
                            data: [{"name":"LeetCode","value":88},{"name":"Medium","value":70},{"name":"Hot100","value":58},{"name":"数组","value":34},{"name":"面试经典150","value":32},{"name":"八股文","value":25},{"name":"❌错题集","value":25},{"name":"深度优先搜索","value":22}].map(tag => tag.name),
                            textStyle: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        }
                    });

                    tagsChart.on('click', function (params) {
                        window.location.href = '/tags/' + params.name;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesChartDom = document.getElementById('categoriesChart');
                if(categoriesChartDom){
                    const categoriesChart = echarts.init(categoriesChartDom, 'dark');
                    categoriesChart.setOption({
                        xAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        yAxis: { 
                            type: 'category', 
                            data: [{"name":"算法刷题","value":101},{"name":"LeetCode","value":99},{"name":"Hot100","value":63},{"name":"八股文","value":50},{"name":"面试经典150","value":35}].map(category => category.name).reverse(), 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        series: [{
                            name: 'Category Count',
                            type: 'bar',
                            data: [{"name":"算法刷题","value":101},{"name":"LeetCode","value":99},{"name":"Hot100","value":63},{"name":"八股文","value":50},{"name":"面试经典150","value":35}].map(category => category.value).reverse(),
                            label: {
                                show: true,
                                position: 'right',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#91CC75' },
                                    { offset: 1, color: '#73C0DE' }
                                ])
                            }
                        }]
                    });

                    categoriesChart.on('click', function (params) {
                        window.location.href = '/categories/' + params.name;
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesTreeChartDom = document.getElementById('categoriesTreeChart');
                if(categoriesTreeChartDom){
                    const treeChart = echarts.init(categoriesTreeChartDom, 'dark');
                    treeChart.setOption({
                        title: {
                            text: '操作提示：单击展开分类，双击进入具体分类页面',
                            textStyle: {
                                fontSize: 12,
                                color: '#999',
                                fontWeight: 'normal'
                            },
                            bottom: 0,
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            triggerOn: 'mousemove'
                        },
                        series: [{
                            type: 'tree',
                            data: [{"name":"Categories","children":[{"name":"面试经验","children":[],"count":8,"path":"面试经验"},{"name":"算法刷题","children":[{"name":"LeetCode","children":[{"name":"面试经典150","children":[{"name":"错题集","children":[],"count":1,"path":"算法刷题/LeetCode/面试经典150/错题集"}],"count":35,"path":"算法刷题/LeetCode/面试经典150"},{"name":"Hot100","children":[],"count":63,"path":"算法刷题/LeetCode/Hot100"}],"count":99,"path":"算法刷题/LeetCode"}],"count":101,"path":"算法刷题"},{"name":"技术八股","children":[{"name":"操作系统","children":[],"count":1,"path":"技术八股/操作系统"},{"name":"Go语言","children":[],"count":8,"path":"技术八股/Go语言"}],"count":10,"path":"技术八股"},{"name":"八股文","children":[{"name":"操作系统","children":[],"count":1,"path":"八股文/操作系统"},{"name":"Go语言","children":[],"count":1,"path":"八股文/Go语言"},{"name":"计算机网络","children":[],"count":1,"path":"八股文/计算机网络"},{"name":"REDIS","children":[{"name":"分布式锁","children":[],"count":1,"path":"八股文/REDIS/分布式锁"},{"name":"缓存","children":[],"count":2,"path":"八股文/REDIS/缓存"},{"name":"高可用","children":[],"count":3,"path":"八股文/REDIS/高可用"},{"name":"基础知识","children":[{"name":"内存管理","children":[],"count":1,"path":"八股文/REDIS/基础知识/内存管理"},{"name":"数据结构","children":[],"count":8,"path":"八股文/REDIS/基础知识/数据结构"},{"name":"数据类型","children":[],"count":5,"path":"八股文/REDIS/基础知识/数据类型"}],"count":19,"path":"八股文/REDIS/基础知识"}],"count":25,"path":"八股文/REDIS"},{"name":"MySQL","children":[{"name":"内存","children":[],"count":1,"path":"八股文/MySQL/内存"},{"name":"基础知识","children":[],"count":5,"path":"八股文/MySQL/基础知识"},{"name":"日志","children":[],"count":1,"path":"八股文/MySQL/日志"},{"name":"锁","children":[],"count":6,"path":"八股文/MySQL/锁"},{"name":"事务","children":[],"count":2,"path":"八股文/MySQL/事务"},{"name":"索引","children":[],"count":7,"path":"八股文/MySQL/索引"}],"count":22,"path":"八股文/MySQL"}],"count":50,"path":"八股文"},{"name":"系统设计","children":[],"count":1,"path":"系统设计"},{"name":"前沿技术","children":[{"name":"AI工程","children":[],"count":1,"path":"前沿技术/AI工程"}],"count":1,"path":"前沿技术"}],"count":0,"path":""}],
                            initialTreeDepth: -1,
                            top: '5%',
                            bottom: '10%',
                            left: '0%',
                            right: '0%',
                            symbolSize: 15,
                            layout: 'orthogonal',
                            orient: 'TB',
                            itemStyle: {
                                color: '#91CC75',
                                borderColor: '#73C0DE'
                            },
                            label: {
                                position: 'bottom',
                                verticalAlign: 'middle',
                                align: 'center',
                                fontSize: 14,
                                distance: 28,
                                formatter: function(params) {
                                    return params.data.name + (params.data.count ? ' (' + params.data.count + ')' : '');
                                }
                            },
                            leaves: {
                                label: {
                                    position: 'top',
                                    verticalAlign: 'middle',
                                    align: 'center'
                                }
                            },
                            emphasis: {
                                focus: 'descendant'
                            },
                            expandAndCollapse: true
                        }]
                    });

                    treeChart.on('dblclick', function (params) {
                        if (params.data && params.data.path) {
                            window.location.href = '/categories/' + params.data.path;
                        }
                    });
                }
            });
        </script>
    
    </body>
</html>
